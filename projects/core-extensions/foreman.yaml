---
schema-version: v1

name: petronia.core.api.foreman
version: [1, 0, 0]
type: api

about: The Foreman Process event details.
description: >
  A well-defined list of events that are received and sent by the Foreman process.
  These are only sent and received as low-level events.  This acts only as documentation
  to describe the event actions that take place, and to help fill out the dependency
  tree for other extensions.  The extension loader needs to assume that this and the
  default implementation are already loaded.
licenses:
  - MIT
authors:
  - Petronia Project
depends: []
default:
  name: petronia.core.impl.foreman
  minimum: [1, 0, 0]

events:

  # -------------------------------------------------------------------------
  "start-launcher:request":
    description: >
      Request that the foreman process start a new launcher.
    priority: io
    # Can only be sent by the extension loader.
    send-access: internal
    receive-access: implementations
    unique-target: launcher
    fields:
      identifier:
        description: used to uniquely identify this spawned launcher.
        type: string
        min-length: 3
        max-length: 200
      launcher:
        description: The launcher category to start.
        type: string
        min-length: 1
        max-length: 200
      permissions:
        description: The action permissions required for the launcher to be able to perform.
        type: array
        value-type:
          type: structure
          fields:
            action:
              description: Requested permission action to gain access to.
              type: string
              min-length: 1
              max-length: 200
            resources:
              description: List of resources to access.
              type: array
              value-type:
                type: string
                min-length: 1
                max-length: 1000
  "start-launcher:success":
    description: >
      Report that a new launcher now exists and is ready to accept extensions.
    priority: high
    send-access: implementations
    receive-access: public
    fields:
      identifier:
        description: used to uniquely identify this spawned launcher.
        type: string
        min-length: 3
        max-length: 200
      target_id:
        description: >
          The fully qualified target ID of the spawned launcher.
          This should be the target-id for events directed to the spawned launcher.
        type: string
        min-length: 5
        max-length: 300

  "start-launcher:failed":
    description: >
      Report that the requested launcher could not be started.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      identifier:
        description: The requested launcher to start which failed.
        type: string
        min-length: 3
        max-length: 200
      error:
        type: reference
        ref: error


  # -------------------------------------------------------------------------
  "launcher-load-extension:request":
    description: >
      Requests a launcher to load an extension.  This event's target id is the launcher
      target-id returned by a "start-launcher:success" event,
      and that declares the permissions that the extension can use.
    priority: io
    send-access: internal
    receive-access: implementations
    fields:
      name:
        description: The extension name to load.
        type: string
      version:
        description: The extension version to load.
        type: reference
        ref: version
      location:
        description: Where the launcher can find the extension.
        type: string

  "launcher-load-extension:success":
    description: >
      Signals a successful request to load the extension.  Further events
      in the extension's lifecycle will be generated by the extension itself.
      The source-id is the launcher that loaded the extension.
    priority: normal
    send-access: implementations
    receive-access: target
    fields:
      name:
        description: The loaded extension name.
        type: string

  "launcher-load-extension:failed":
    description: >
      Report that the requested extension could not be loaded by the loader.
      The source-id is the launcher that loaded the extension.
    priority: normal
    send-access: implementations
    receive-access: target
    fields:
      name:
        description: The loaded extension name.
        type: string
      error:
        type: reference
        ref: error

  extension-add-event-listener:
    description: >
      Request from the extension loader to add an event listener for an extension.
      Failures happen silently (no response back is made).  The target_id must match
      with the ID for the launcher that owns the extension.
    priority: normal
    send-access: internal
    receive-access: implementations
    fields:
      extension_name:
        description: The extension name.
        type: string
      events:
        type: reference
        ref: event_list

  extension-remove-event-listener:
    description: >
      Request from the extension loader to remove an event listener for an extension.
      Failures happen silently (no response back is made).  The target_id must match
      with the ID for the launcher that owns the extension.
    priority: normal
    send-access: internal
    receive-access: implementations
    fields:
      extension_name:
        description: The extension name.
        type: string
      events:
        type: reference
        ref: event_list

  # -------------------------------------------------------------------------
  restart:
    description: >
      Force the Petronia extensions to restart themselves.  This can only be sent through
      "internal" extensions because normal operation requires shutdown phases.
    priority: normal
    send-access: internal
    receive-access: implementations
    unique-target: restart
    fields: {}
  stop:
    description: >
      Terminate Petronia.  This can only be sent through "internal" extensions because normal
      operation requires shutdown phases.
    priority: io
    send-access: internal
    receive-access: implementations
    unique-target: stop
    fields: {}


references:
  error:
    type: structure
    description: A failure
    fields:
      identifier:
        type: string
        min-length: 2
        max-length: 255
        description: The identifier that uniquely defines this error.
      source:
        type: string
        optional: true
        description: The source of the error, if known.
      message:
        type: string
        description: A localizable message.
      arguments:
        type: array
        description: arguments for the message.
        value-type:
          type: selector
          type-mapping:
            string:
              type: string
            int:
              type: int
            float:
              type: float
  version:
    type: array
    min-length: 3
    max-length: 3
    value-type:
      type: int

  event_list:
    description: list of events to stop listening to.
    type: array
    value-type:
      type: reference
      ref: event_target

  event_target:
    description: A target event for an extension listening.
    type: structure
    fields:
      event_id:
        description: ID of the event to listen to.  Very few extensions are allowed to listen to all events.
        type: string
        optional: true
      target_id:
        description: ID of the event's target to listen to.  If the target is not given, then any target for the event is listened to.
        type: string
        optional: true
