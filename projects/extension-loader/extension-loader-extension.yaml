---
schema-version: v1

name: petronia.core.api.extension_loader
type: api
version: [1, 0, 0]
about: Loads extensions into the system.
description: >
  Accepts requests to load extensions.  This interacts closely with the Foreman process to ensure
  the loaded extensions run in the correct security context.
licenses:
  - MIT
authors:
  - Petronia Project
default:
  name: petronia.core.impl.extension_loader
  minimum: [1, 0, 0]
depends:
  - name: petronia.core.api.foreman
    minimum: [1, 0, 0]
    below: [2, 0, 0]


state-data:
  active-extensions:
    description: >
      List of active extensions.
    fields:
      extensions:
        description: List of active extensions.
        type: array
        min-length: 1
        max-length: 90000
        value-type:
          type: reference
          ref: extension-info


events:
  "load-extension:request":
    description: >
      Request for an extension be loaded into Petronia.  The extension loader will examine the
      request and decide whether the extension can be loaded.  The extension loader will also
      use its internal settings to determine from where to load the extension.  Responses
      will be sent with a target id matching the request's source id.
    priority: io
    send-access: public
    receive-access: implementations
    unique-target: loader
    fields:
      name:
        description: The fully qualified extension name to load.
        type: reference
        ref: extension-name
      minimum_version:
        description: >
          The minimum version to load.  If not given, then the extension loader will
          ignore lower bounds for the version number.
        optional: true
        type: reference
        ref: extension-version
      below_version:
        description: >
          The loaded extension must have a version below this value.  If not specified, then
          there is no maximum version number.
        optional: true
        type: reference
        ref: extension-version

  "load-extension:failed":
    description: >
      The request to load an extension was denied or the extension failed to load.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      name:
        description: The extension requested to load which failed.
        type: reference
        ref: extension-name
      error:
        type: reference
        ref: error

  "load-extension:success":
    description: >
      The request to load the extension succeeded.  Other events related to the extension loading
      may be sent, but that is in a different life cycle.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      name:
        description: The loaded extension name.
        type: reference
        ref: extension-name
      version:
        description: The loaded extension version.
        type: reference
        ref: extension-version

  register-extension-listeners:
    description: >
      Request by an extension to add a listener of events.  The source of the request
      is the extension name.
    priority: normal
    send-access: public
    receive-access: implementations
    unique-target: listener-registration
    fields:
      events:
        description: list of the events to listen to.
        type: array
        min-length: 1
        max-length: 100
        value-type:
          type: reference
          ref: event-listener

  remove-extension-listeners:
    description: >
      Request by an extension to remove a listener of events.  The source of the request
      is the extension name.
    priority: normal
    send-access: public
    receive-access: implementations
    unique-target: listener-registration
    fields:
      events:
        description: list of the events to stop listening to.
        type: array
        min-length: 1
        max-length: 100
        value-type:
          type: reference
          ref: event-listener

  system-started:
    description: >
      An "all clear" message indicating that the boot-time declared extensions have had
      their "load-extension:success" messages sent.
    priority: normal
    send-access: implementations
    receive-access: public
    unique-target: system
    fields: {}

references:
  # ------------------------------
  # Standard Data Types ...
  extension-name:
    description: Standard name requirements for an extension.
    type: string
    min-length: 3
    max-length: 200
  extension-version:
    description: Version number for an extension.  It must be a three part number.
    type: array
    min-length: 3
    max-length: 3
    value-type:
      type: int
      min-value: 0
      max-value: 999999
  event-id:
    description: ID of an event.
    type: string
    min-length: 5
    max-length: 600
  event-target-id:
    description: ID of an event listener.
    type: string
    min-length: 5
    max-length: 600
  localizable-message:
    description: A localizable message for user display.
    type: structure
    fields:
      catalog:
        description: >
          The name of the translation file, or "domain", that contains
          the translations.
        type: string
        min-length: 2
        max-length: 300
      message:
        description: >
          The message ID to look up in the catalog.  If the message
          has no translation, this is directly displayed to the user.
        type: string
        min-length: 1
        max-length: 10000
      arguments:
        description: >
          List of arguments to be inserted into the translated message.
          Each argument should have a distinct name from all the other
          arguments in this message; the name is how the message references
          the arguments.
        type: array
        min-length: 0
        max-length: 100
        optional: true
        value-type:
          type: reference
          ref: message-argument
  message-argument:
    description: An argument to be inserted into the localizable message.
    type: structure
    fields:
      name:
        description: Name of the arugment, referenced by the message.
        type: string
        min-length: 1
        max-length: 50
      value:
        description: Value of the argument.  It must be a simple type.
        type: reference
        ref: message-argument-value
  message-argument-value:
    description: A replacement value for a named argument in the message.
    type: selector
    type-mapping:
      string:
        type: string
        min-length: 0
        max-length: 10000
      int:
        type: int
      float:
        type: float
      bool:
        type: bool
      datetime:
        type: datetime
      string_list:
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: string
          min-length: 0
          max-length: 10000
      int_list:
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: int
      float_list:
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: float
      bool_list:
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: bool
      datetime_list:
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: datetime
  error:
    type: structure
    description: A description of a failure.
    fields:
      identifier:
        description: >
          The identifier that uniquely defines this error.  Useful for
          automation that needs to perform operations based on specific
          error messages.
        type: string
        min-length: 5
        max-length: 600
      categories:
        description: >
          A collection of general categories that define the error.
          Useful for automation that can act differently depending on
          the contents.
        type: array
        min-length: 1
        max-length: 100
        value-type:
          description: General error category.
          type: enum
          values:
            - file
            - os
            - configuration
            - network
            - access-restriction
            - invalid-user-action
            - internal
      source:
        description: The source of the error, if known.
        type: string
        min-length: 2
        max-length: 300
        optional: true
      messages:
        description: The localizable messages associated with this error.
        type: array
        min-length: 1
        max-length: 100
        value-type:
            type: reference
            ref: localizable-message

  # ------------------------------
  # Local data types ...

  event-listener:
    type: structure
    description: An event to listen on.
    fields:
      event_id:
        type: reference
        ref: event-id
        optional: true
      target_id:
        type: reference
        ref: event-target-id
        optional: true

  extension-info:
    type: structure
    description: Information about a single extension.
    fields:
      name:
        description: The loaded extension name.
        type: reference
        ref: extension-name
      version:
        description: The loaded extension version.
        type: reference
        ref: extension-version
      about:
        description: Short description for the extension.
        type: string
        min-length: 0
        max-length: 300
      description:
        description: Long description about the extension.
        type: string
        min-length: 0
        max-length: 65535
      authors:
        description: List of people or organizations who worked on the extension.
        type: array
        min-length: 0
        max-length: 100
        value-type:
          type: string
          min-length: 1
          max-length: 300
      licenses:
        description: List of licenses for the extension.  This is an "or" list.
        type: array
        min-length: 0
        max-length: 10
        value-type:
          type: string
          min-length: 1
          max-length: 300
