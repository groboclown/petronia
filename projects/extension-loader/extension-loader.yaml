---

name: petronia.core.api.extension_loader
type: api
version: [1, 0, 0]
about: Loads extensions into the system.
description: >
  Accepts requests to load extensions.  This interacts closely with the Foreman process to ensure
  the loaded extensions run in the correct security context.
licenses:
  - MIT
authors:
  - Petronia Project
default:
  name: petronia.core.impl.extension-loader
  minimum: [1, 0, 0]
depends:
  - name: petronia.core.api.foreman
    minimum: [1, 0, 0]
    below: [2, 0, 0]


events:
  "load-extension:request":
    description: >
      Request for an extension be loaded into Petronia.  The extension loader will examine the
      request and decide whether the extension can be loaded.  The extension loader will also
      use its internal settings to determine from where to load the extension.
    priority: io
    send-access: public
    receive-access: implementations
    fields:
      name:
        description: The fully qualified extension name to load.
        type: string
      minimum_version:
        description: >
          The minimum version to load.  If not given, then the extension loader will
          ignore lower bounds for the version number.
        optional: true
        type: reference
        ref: version
      below_version:
        description: >
          The loaded extension must have a version below this value.  If not specified, then
          there is no maximum version number.
        optional: true
        type: reference
        ref: version

  "load-extension:failed":
    description: >
      The request to load an extension was denied or the extension failed to load.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      name:
        description: The extension requested to load which failed.
        type: string
      error:
        type: reference
        ref: error

  "load-extension:success":
    description: >
      The request to load the extension succeeded.  Other events related to the extension loading
      may be sent, but that is in a different life cycle.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      name:
        description: The loaded extension name.
        type: string
      version:
        description: The loaded extension version.
        type: reference
        ref: version

  system-started:
    description: >
      An "all clear" message indicating that the boot-time declared extensions have had
      their "load-extension:success" messages sent.
    priority: normal
    send-access: implementations
    receive-access: public
    fields:
      loaded_extensions:
        description: list of all loaded extensions that were declared in the boot-time list.
        type: array
        min-length: 0
        max-length: 60000
        value-type:
          type: structure
          description: A loaded extension
          fields:
            name:
              description: The loaded extension name.
              type: string
            version:
              description: The loaded extension version.
              type: reference
              ref: version

  # TODO add in extension-register-listeners and extension-deregister-listeners
  #   to allow for an extension to listen to certain events.

references:
  version:
    type: array
    min-length: 3
    max-length: 3
    value-type:
      type: int
  error:
    type: structure
    description: A failure
    fields:
      identifier:
        type: string
        min-length: 2
        max-length: 255
        description: The identifier that uniquely defines this error.
      source:
        type: string
        optional: true
        description: The source of the error, if known.
      message:
        type: string
        description: A localizable message.
      arguments:
        type: array
        description: arguments for the message.
        value-type:
          type: selector
          type-mapping:
            string:
              type: string
            int:
              type: int
            float:
              type: float
